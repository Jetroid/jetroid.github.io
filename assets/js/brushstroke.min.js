!function(t,i){"function"==typeof define&&define.amd?define([],i):"object"==typeof module&&module.exports?module.exports=i():t.Brushstroke=i()}(this,function(){function t(t,i,e,s){"use strict";function n(t,i,s,n){for(var o,r=2;r<s;r+=2){var a,l,d,c,f=t[r],p=t[r+1],m=t[r+2],g=t[r+3],v=(m-t[r-2])*n,x=(g-t[r-1])*n,y=(t[r+4]-f)*n,_=(t[r+5]-p)*n,P=0;for(o=0;o<e;o++)a=i[P++],l=i[P++],d=i[P++],c=i[P++],u[h++]=a*f+l*m+d*v+c*y,u[h++]=a*p+l*g+d*x+c*_}}i="number"==typeof i?i:.5,e="number"==typeof e?e:25;var o,r=1,a=t.length,h=0,l=(a-2)*e+2+(s?2*e:0),u=new Float32Array(l),d=new Float32Array(4*(e+2)),c=4;for(o=t.slice(0),s?(o.unshift(t[a-1]),o.unshift(t[a-2]),o.push(t[0],t[1])):(o.unshift(t[1]),o.unshift(t[0]),o.push(t[a-2],t[a-1])),d[0]=1;r<e;r++){var f=r/e,p=f*f,m=p*f,g=2*m,v=3*p;d[c++]=g-v+1,d[c++]=v-g,d[c++]=m-2*p+f,d[c++]=m-p}return d[++c]=1,n(o,d,a,i),s&&(o=[],o.push(t[a-4],t[a-3],t[a-2],t[a-1],t[0],t[1],t[2],t[3]),n(o,d,4,i)),a=s?0:t.length-2,u[h++]=t[a++],u[h]=t[a],u}function i(t,i,e){v.fnc(t)&&t.call(i,e)}function e(t,i){for(var e in i)t[e]=i[e];return t}function s(t,i){t||(t={});for(var s=1;s<arguments.length;s++)e(t,arguments[s]);return t}function n(t,i){try{return!v.und(i)&&!v.obj(i)&&!v.fnc(i)&&i.length>0&&i!=parseInt(i)&&t!=parseInt(t)}catch(t){return!1}}function o(t){var i=getComputedStyle(t),e="";for(var s in i)n(s,i[s])&&(e+=s+":"+i[s]+";");t.style.cssText+=e+";visibility:visible;"}function r(t,i){for(var e=t.children,s=0;s<e.length;s++)r(e[s],i);i.push({el:t,style:t.style.cssText}),o(t)}function a(t){for(var i,e=0;e<t.length;e++)i=t[e],i.style?i.el.style.cssText=i.style:i.el.removeAttribute("style")}function h(t){var i=[];r(t,i);var e=t.outerHTML;return a(i),e}function l(t){var i=getComputedStyle(t),e=i.getPropertyValue("position");"static"===e&&(t.style.position="relative")}function u(t){var i=t.el.getBoundingClientRect(),e=t.root.getBoundingClientRect();t.top=i.top-e.top,t.left=i.left-e.left}function d(){return new function(){this.resolve=null,this.reject=null,this.promise=new Promise(function(t,i){this.resolve=t,this.reject=i}.bind(this))}}function c(t,i,e){for(var s=t||10,n=[],o=0;o<s;o++)n.push(i*Math.random()*.9+.05*i|0,e*Math.random()*.9+.05*e|0);return n}function f(t,i){var e=document.createElement("canvas");e.width=i.width,e.height=i.height;var s=e.getContext("2d");if(i.stretch)s.drawImage(t,0,0,i.width,i.height);else{var n=t.width,o=t.height,r=i.width/2-n/2,a=i.height/2-o/2;s.drawImage(t,r,a,n,o)}return e}function p(t){t.el&&(t.width=t.el.offsetWidth,t.height=t.el.offsetHeight,u(t));var i=document.createElement("canvas");i.style.position="absolute",i.style.top=t.top+"px",i.style.left=t.left+"px",i.width=t.width,i.height=t.height,i.style.visibility="hidden",t.canvas=i,t.ctx=i.getContext("2d"),l(t.root),t.root.appendChild(t.canvas)}function m(t){this.defaults={animation:"to-bottom",path:void 0,points:void 0,frameAnimation:!1,frames:0,duration:0,delay:0,color:"#ccc",width:300,height:120,size:40,inkAmount:1,lifting:!1,dripping:!1,splashing:!0,padding:30,overlap:10,tension:.5,reduceOverflow:20,root:document.body,el:void 0,image:void 0,repeat:"no-repeat",stretch:!1,centered:!1,queue:!1},this.init(t)}var g=function(){function t(t,i,e,s,n,o,r,a){this.x=t||0,this.y=i||0,void 0!==e&&(this.color=e),void 0!==s&&(this.size=s),void 0!==n&&(this.inkAmount=n),void 0!==o&&(this.angle=o),void 0!==r&&(this.dripping=r),void 0!==a&&(this.splashing=a),this._drops=[],this._resetTip()}function i(t,i,e,s){this.x=t||0,this.y=i||0,this.inkAmount=e,this.color=s,this._latestPos={x:this.x,y:this.y}}function e(t,i,e,s,n){this.x=t||0,this.y=i||0,this.size=e,this.color=s,this.strokeId=n,this.life=1.5*this.size,this._latestPos={x:this.x,y:this.y}}return t.prototype={_SPLASHING_BRUSH_SPEED:75,angle:0,x:0,y:0,color:"#000",size:35,inkAmount:7,splashing:!0,dripping:!0,maxHairs:1e3,_latestPos:null,_strokeId:null,_drops:null,isStroke:function(){return Boolean(this._strokeId)},startStroke:function(){this.isStroke()||(this._resetTip(),this._strokeId="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i,e;return i=16*Math.random()|0,e="x"===t?i:3&i|8,e.toString(16)}))},endStroke:function(){this._strokeId=this._latestPos=null},render:function(t,i,s){var n,o,r,a,h=this.isStroke();if(this._latestPos||(this._latestPos={}),this._latestPos.x=this.x,this._latestPos.y=this.y,this.x=i,this.y=s,this._drops.length){var l,u=this._drops,d=this.size*this.size;for(r=0,a=u.length;r<a;r++)l=u[r],n=this.x-l.x,o=this.y-l.y,h&&d>n*n+o*o&&this._strokeId!==l.strokeId||l.life<=0?(u.splice(r,1),a--,r--):l.render(t)}if(h){var c,f=this._tip;this._strokeId;if(n=this.x-this._latestPos.x,o=this.y-this._latestPos.y,c=Math.sqrt(n*n+o*o),this.splashing&&c>this._SPLASHING_BRUSH_SPEED){var p,m,g,v,x,y=.5*(c-this._SPLASHING_BRUSH_SPEED)|0;for(t.save(),t.fillStyle=this.color,t.beginPath(),r=0,a=y*Math.random()|0;r<a;r++)p=(c-1)*Math.random()+1,m=2*Math.PI*Math.random(),g=5*Math.random(),v=this.x+p*Math.sin(m),x=this.y+p*Math.cos(m),t.moveTo(v+g,x),t.arc(v,x,g,0,2*Math.PI,!1);t.fill(),t.restore()}else this.dripping&&c<2*this.inkAmount&&Math.random()<.05&&this._drops.push(new e(this.x,this.y,.5*(this.size+this.inkAmount)*(.15*Math.random()+.1),this.color,this._strokeId));for(r=0,a=f.length;r<a;r++)f[r].render(t,n,o,c)}},dispose:function(){this._tip.length=this._drops.length=0},_resetTip:function(){var t,e,s,n,o,r,a,h,l,u,d=this._tip=[],c=.5*this.size;for(r=this.angle,u=c*c*Math.PI/this.inkAmount|0,u<1&&(u=1),u>this.maxHairs&&(u=this.maxHairs),l=0;l<u;l++)t=c*Math.random(),e=.5*t,s=2*Math.PI*Math.random(),n=t*Math.sin(s),o=e*Math.cos(s),a=Math.cos(r),h=Math.sin(r),d.push(new i(this.x+n*a-o*h,this.y+n*h+o*a,this.inkAmount,this.color))}},i.prototype={x:0,y:0,inkAmount:7,color:"#000",_latestPos:null,render:function(t,i,e,s){this._latestPos.x=this.x,this._latestPos.y=this.y,this.x+=i,this.y+=e;var n=s?this.inkAmount/s:0;n>1?n=1:n<0&&(n=0),t.save(),t.lineCap=t.lineJoin="round",t.strokeStyle=this.color,t.lineWidth=this.inkAmount*n,t.beginPath(),t.moveTo(this._latestPos.x,this._latestPos.y),t.lineTo(this.x,this.y),t.stroke(),t.restore()}},e.prototype={x:0,y:0,size:7,color:"#000",strokeId:null,life:0,_latestPos:null,_xOffRatio:0,render:function(t){Math.random()<.03?this._xOffRatio+=.06*Math.random()-.03:Math.random()<.1&&(this._xOffRatio*=.003),this._latestPos.x=this.x,this._latestPos.y=this.y,this.x+=this.life*this._xOffRatio,this.y+=.5*this.life*Math.random(),this.life-=.04*Math.random()+.01,t.save(),t.lineCap=t.lineJoin="round",t.strokeStyle=this.color,t.lineWidth=this.size+.3*this.life,t.beginPath(),t.moveTo(this._latestPos.x,this._latestPos.y),t.lineTo(this.x,this.y),t.stroke(),t.restore(),t.restore()}},t}(),v={obj:function(t){return Object.prototype.toString.call(t).indexOf("Object")>-1},num:function(t){return"number"==typeof t},str:function(t){return"string"==typeof t},fnc:function(t){return"function"==typeof t},und:function(t){return"undefined"==typeof t}};return m.prototype={init:function(t){var i=s(this.defaults,t);v.str(i.root)&&(i.root=document.querySelector(i.root)),v.str(i.el)&&(i.el=document.querySelector(i.el)),p(i);var e=d();this.promise=e.promise,e.resolve()},run:function(t){function e(){t.canvas.style.visibility="visible",t.render?s.render(t):i(s.animations[t.animation],s,t)}var s=this;if(t.clear)t.ctx.clearRect(0,0,t.width,t.height),t.d.resolve();else if(t.el)if(t.pattern)e();else{var n="<style>body{margin:0;}</style>"+h(t.el);rasterizeHTML.drawHTML(n,null).then(function(i){t.fill?(t.ctx.drawImage(i.image,0,0,t.width,t.height),t.d.resolve()):(t.pattern=t.ctx.createPattern(i.image,t.repeat),e())},function(t){console.log("rasterizeHTMLError: "+t)})}else if(t.image){var o=new Image;o.onload=function(){(t.stretch||t.centered)&&(o=f(o,t)),t.fill?(t.ctx.drawImage(o,0,0,t.width,t.height),t.d.resolve()):(t.pattern=t.ctx.createPattern(o,t.repeat),e())},o.src=t.image}else e()},draw:function(t){var i=this,e=s({},this.defaults,t),n=function(){var t=d();return i.run(s(e,{d:t})),t.promise};e.queue?this.promise=this.promise.then(n):n()},erase:function(t){this.draw(s({},t,{erase:!0}))},fill:function(t){this.draw(s({},t,{fill:!0}))},clear:function(t){this.draw(s({},t,{clear:!0}))},setPath:function(t){var i=t.path;v.str(i)&&(i=document.createElementNS("http://www.w3.org/2000/svg","path"),i.setAttribute("d",t.path),t.path=i),t.pathLenght=i.getTotalLength()},pointAt:function(t,i){switch(i.animation){case"points":var e=i.points,s=e.length,n=2*Math.round(s*t/2);return n>=s&&(n=s-2),{x:e[n],y:e[n+1]};case"path":return i.path.getPointAtLength(i.pathLenght*t);default:return null}},setPos:function(t,i){var e=!i;switch(e&&(i={}),t.direction){case"bottom":i.startY=e?t.padding:i.startY+t.size-t.overlap,this.setPosBottomTop(t,i,e);break;case"top":i.startY=e?t.height-t.padding:i.startY-t.size+t.overlap,this.setPosBottomTop(t,i,e);break;case"right":i.startX=e?t.padding:i.startX+t.size-t.overlap,this.setPosRightLeft(t,i,e);break;case"left":i.startX=e?t.width-t.padding:i.startX-t.size+t.overlap,this.setPosRightLeft(t,i,e)}return i},setPosBottomTop:function(t,i,e){if(e)i.vertical=!0;else var s=i.startX;i.startX=e?t.padding:i.x,i.x=e?t.width-t.padding:s,i.y=i.startY},setPosRightLeft:function(t,i,e){if(e)i.vertical=!1;else var s=i.startY;i.x=i.startX,i.startY=e?t.padding:i.y,i.y=e?t.height-t.padding:s},render:function(t){if(!v.und(t.duration)||!v.und(t.frames)){var e=this;if(t.delay){var s=t.delay;return delete t.delay,void setTimeout(function(){e.render(t)},1e3*s)}t.erase&&(t.ctx.globalCompositeOperation="destination-out");var n,o,r,a,h=1,l=0,u=0,d=new Date;v.und(t.startX)||(l=t.startX),v.und(t.startY)||(u=t.startY);var c=new g(l,u,t.pattern||t.color,t.size,t.inkAmount,t.angle,t.dripping,t.splashing);c.startStroke(l,u),i(t.begin),t.frameAnimation&&t.duration&&(t.frames||(t.frames=60*parseFloat(t.duration)),delete t.duration),function s(){t.duration?(n=(new Date-d)/1e3,o=n/parseFloat(t.duration)):o=h/parseFloat(t.frames),r=o,v.fnc(t.easing)&&(r=t.easing(r)),o>1&&(r=1),a=e.pointAt(r,t),a||(a={x:l+(t.x-l)*r,y:u+(t.y-u)*r}),l=a.x,u=a.y,c.render(t.ctx,l,u),o>=1?(c.endStroke(),t.erase&&(t.ctx.globalCompositeOperation="source-over"),i(t.end),t.d.resolve()):t.duration?requestAnimationFrame(s):(h++,t.frameAnimation?requestAnimationFrame(s):s())}()}},animations:{"to-bottom":function(t){i(this.animations.basic,this,s(t,{direction:"bottom"}))},"to-top":function(t){i(this.animations.basic,this,s(t,{direction:"top"}))},"to-right":function(t){i(this.animations.basic,this,s(t,{direction:"right"}))},"to-left":function(t){i(this.animations.basic,this,s(t,{direction:"left"}))},basic:function(t){function e(t){0===m&&(a[t]=a[t]-p),1===m&&(a[t]=a[t]+p),m===h-1&&(a[t]=f?a[t]+p:a[t]-p)}for(var n,o,r,a=this.setPos(t),h=Math.ceil(((a.vertical?t.height:t.width)+t.size/2-2*t.padding)/(t.size-t.overlap)),l=a.vertical?.5*Math.PI:0,u=t.duration/h,d=t.frames/h,c=[],f=!0,p=t.reduceOverflow,m=0;m<h;m++)t.lifting?(o=0===m,r=m===h-1,n=s({},t,a,{duration:u,frames:d,angle:l,render:!0,queue:!0}),o||(n.begin=null),r||(n.end=null),this.draw(n)):(p&&e(a.vertical?"x":"y"),c.push(a.startX,a.startY,a.x,a.y)),this.setPos(t,a),f=!f;t.lifting?t.d.resolve():i(this.animations.points,this,s(t,{animation:"points",points:c,angle:l}))},path:function(t){this.setPath(t);var i=this.pointAt(0,t);this.render(s(t,{startX:i.x,startY:i.y}))},points:function(i){var e=i.points||0;e=v.num(e)?c(e,i.width,i.height):e,e=t(e,i.tension),this.render(s(i,{points:e,startX:e[0],startY:e[1]}))}}},m});